import { DuneClient } from "@cowprotocol/ts-dune-client";
import { backFillTokenImbalances } from "../../scripts/lib";
import { getSampleSet } from "../../src/dune";
import { EnsoSimulator } from "../../src/simulate/enso";

function getDuneClient(): DuneClient {
  const { DUNE_API_KEY } = process.env;
  return new DuneClient(DUNE_API_KEY!);
}

describe.skip("Run Back Fill!", () => {
  test("back fill January 1, 2023", async () => {
    const { DUNE_API_KEY, NODE_URL, DB_URL } = process.env;
    const simulator = new EnsoSimulator(
      "http://127.0.0.1:8080/api/v1/simulate"
    );
    await backFillTokenImbalances(
      "2023-02-01",
      "2023-02-02",
      DB_URL!,
      NODE_URL!,
      DUNE_API_KEY!,
      simulator
    );
  }, 30000000);

  test("get sample set", async () => {
    const sampleSet = await getSampleSet(
      getDuneClient(),
      "2023-01-01",
      "2023-01-02"
    );

    expect(sampleSet.length).toEqual(519);
    expect(sampleSet[0]).toEqual({
      blockNumber: 16308206,
      from: "0xc9ec550bea1c64d779124b23a26292cc223327b6",
      hash: "0x55891e4127424f64cb3debb96950ba1c2d870ac6a74c85ea8715f80a589e8e9c",
      logs: [
        {
          address: "0x9008d19f58aabd9ed0d60971565aa8510560ab41",
          data: "0x000000000000000000000000514910771af9ca656af840dff83e8264ecf986ca000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb4800000000000000000000000000000000000000000000008d7a00a74f97572e13000000000000000000000000000000000000000000000000000000035f3d0343000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000000386c6441957665a404ef2df3d09976a558b12de17e04a4065ce6b8aa1794357ad7f75200b7684a120fba433145609112616749c08263ba05e20000000000000000",
          index: 392,
          topics: [
            "0xa07a543ab8a018198e99ca0184c93fe9050a79400a0a723441f84de1d972cc17",
            "0x000000000000000000000000f75200b7684a120fba433145609112616749c082",
          ],
        },
        {
          address: "0x514910771af9ca656af840dff83e8264ecf986ca",
          data: "0x00000000000000000000000000000000000000000000008d7a00a74f97572e13",
          index: 393,
          topics: [
            "0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef",
            "0x000000000000000000000000f75200b7684a120fba433145609112616749c082",
            "0x0000000000000000000000009008d19f58aabd9ed0d60971565aa8510560ab41",
          ],
        },
        {
          address: "0x514910771af9ca656af840dff83e8264ecf986ca",
          data: "0x00000000000000000000000000000000000000000000008d6dee05cef8700000",
          index: 394,
          topics: [
            "0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef",
            "0x0000000000000000000000009008d19f58aabd9ed0d60971565aa8510560ab41",
            "0x000000000000000000000000af0b0000f0210d0f421f0009c72406703b50506b",
          ],
        },
        {
          address: "0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48",
          data: "0x000000000000000000000000000000000000000000000000000000035f3d0344",
          index: 395,
          topics: [
            "0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef",
            "0x000000000000000000000000af0b0000f0210d0f421f0009c72406703b50506b",
            "0x0000000000000000000000009008d19f58aabd9ed0d60971565aa8510560ab41",
          ],
        },
        {
          address: "0xdef1c0ded9bec7f1a1670819833240f027b25eff",
          data: "0xc512a580fe2c106f39f293456ec95c901189dc85010fd8bbbcb305636d42135b000000000000000000000000af0b0000f0210d0f421f0009c72406703b50506b0000000000000000000000009008d19f58aabd9ed0d60971565aa8510560ab41000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb48000000000000000000000000514910771af9ca656af840dff83e8264ecf986ca00000000000000000000000000000000000000000000008d6dee05cef8700000000000000000000000000000000000000000000000000000000000035f3d03440000000000000000000000000000000000000000000000000000000000000000",
          index: 396,
          topics: [
            "0x829fa99d94dc4636925b38632e625736a614c154d55006b7ab6bea979c210c32",
          ],
        },
        {
          address: "0x9008d19f58aabd9ed0d60971565aa8510560ab41",
          data: "0x0000000000000000000000000000000000000000000000000000000000000000aa77476c00000000000000000000000000000000000000000000000000000000",
          index: 397,
          topics: [
            "0xed99827efb37016f2275f98c4bcf71c7551c75d59e9b450f79fa32e60be672c2",
            "0x000000000000000000000000def1c0ded9bec7f1a1670819833240f027b25eff",
          ],
        },
        {
          address: "0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48",
          data: "0x000000000000000000000000000000000000000000000000000000035f3d0343",
          index: 398,
          topics: [
            "0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef",
            "0x0000000000000000000000009008d19f58aabd9ed0d60971565aa8510560ab41",
            "0x000000000000000000000000f75200b7684a120fba433145609112616749c082",
          ],
        },
        {
          address: "0x9008d19f58aabd9ed0d60971565aa8510560ab41",
          data: "0x",
          index: 399,
          topics: [
            "0x40338ce1a7c49204f0099533b1e9a7ee0a3d261f84974ab7af36105b8c4e9db4",
            "0x000000000000000000000000c9ec550bea1c64d779124b23a26292cc223327b6",
          ],
        },
      ],
    });
  }, 30000000);
});
